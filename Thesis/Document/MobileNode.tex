\documentclass[12pt, a4paper,twoside]{tesi_upf}


%CODIFICACIÓ
\usepackage[latin1]{inputenc}


%IDIOMES
\usepackage[catalan,english]{babel}

%NOMÉS PER A OBTENIR INDICACIÓ DEL MARC EN MIDA A4
\usepackage[cam,a4,center,frame]{crop}

%PER A INCLOURE GRÀFICS I EL LOGO DE LA UPF
\usepackage{graphicx}
\usepackage{caption}
\usepackage{acronym}
\usepackage{multirow}
%FONTS TIMES O GARAMOND, 
\usepackage{times}
%\usepackage{garamond}

\usepackage{pdfpages}
%SENSE HEADINGS: NO MODIFICAR
\pagestyle{plain}

%PER A L'ÍNDEX DE MATÈRIES
\usepackage{makeidx}
\makeindex

%ESTIL DE BIBLIOGRAFIA
\bibliographystyle{apalike}


%AQUEST DOCUMENT ÉS EN CATALÀ
\selectlanguage{english}

%EN COMPTES DE ÍNDEX, LA TAULA DE CONTINGUTS ES TITULA SUMARI
\addto\captionscatalan
  {\renewcommand{\contentsname}{\Large \sffamily Sumari}}


%AFEGIU EN AQUESTA PART LES VOSTRES DADES
\title{A mobile streaming solution for IEEE 802.11 infrastructure and mesh networks}
\author{Fernando Gros González}
\thyear{2013}
\department{Departament de Tecnologies de la Informació i les Comunicacions (DTIC)}
\supervisor{Jaume Barceló, Efraín Foglia}


\begin{document}


\frontmatter

\maketitle

\cleardoublepage


%%%%%% Dedicatòria; si no es vol posar, comenteu fins a final de dedicatòria

\noindent Escriviu aquí la vostra dedicatòria

\cleardoublepage

%%%%%% Final de dedicatòria


%%%%%% Agraïments; si no es vol posar, comenteu fins a final de agraïments
\noindent {\Large \sffamily Acknowledgments} This work was partially supported by the European Commission through the project Commons for Europe (CIP-ICT-PSP-2011-5-297191)

\cleardoublepage

%%%%%% Final dels agraïments

%ABSTRACT EN DOS IDIOMES. COM A MÍNIM CATALÀ. SI L'ALTRE ÉS EN CASTELLA CANVIEU EL QUE POSA ABSTRACT
\selectlanguage{english}
\section*{\Large \sffamily Abstract}

The Mobile Node is a platform that is being developed to provide temporary wireless network coverage to events. The Mobile Node uses IEEE 802.11 technology combined with the ``quick mesh project'' (QMP) firmware and advanced mesh routing protocols (BMX, OLSR). In this thesis we have documented how does this platform work internally and how can be used to improve existing fixed mesh networks. Furthermore, we have developed an audio and video streaming application for android devices. This application can be used in combination with the Mobile Node technology and also on its own by connecting to any IEEE 802.11 network.  When we combine this platform with the open mesh networks already deployed, we are providing the users with new solutions to continue improving their networks and to run applications over them.

\selectlanguage{catalan}
\vspace*{\fill}
\section*{\Large \sffamily  Resum}

El Node Mòbil es una plataforma que està essent desenvolupada per a proporcionar cobertura  de xarxa sense fils en esdeveniments. El Node Mòbil utilitza la tecnologia del IEEE 802.11 combinada amb el firmware ``Quick Mesh Project'' (QMP) i protocols d'enrutament avançats (BMX, OLSR). En aquest treball hem documentat com funciona internament aquesta plataforma i com es pot utilitzar per a millorar les xarxes mesh fixes ja existents. A més, hem desenvolupat una aplicació de streaming de àudio y vídeo per a dispositius Android.  Aquesta aplicació es pot utilitzar en combinació amb la tecnologia de Node Mòbil o en qualsevol xarxa IEEE 802.11. Quan combinem aquesta plataforma amb xarxes mesh obertes que ja estan desplegades,  estem oferint als usuaris noves solucions per a continuar millorant les seves xarxes i per a executar aplicacions sobre elles. 

\vspace*{\fill}

\selectlanguage{english}
\cleardoublepage
%FIN DE ABSTRACTE

%PREFACI OPCIONAL. SI NO ES VOL, COMENTEU FINS EL FINAL DE PREFACI
%{\bf Prefaci}
%
%\cleardoublepage
%FINAL DE PREFACI


%TAULA DE CONTINGUTS: OBLIGATÒRIA
\tableofcontents

%INDEX DE FIGURES; NOMÉS ES POSA SI HI HA FIGURES
\listoffigures
%Fa que aparegui al sumari
\addcontentsline{toc}{chapter}{List of figures}

%INDEX DE TAULES; NOMÉS ES POSA SI HI HA TAULES
\listoftables
%Fa que aparegui al sumari
\addcontentsline{toc}{chapter}{List of tables}

%INDEX DE ACRONIMS
\cleardoublepage
\thispagestyle{empty}
\addcontentsline{toc}{chapter}{List of Abbreviations}
\vspace*{1.95cm} \hspace*{-0.155cm} %,88
\textbf{{\huge \sffamily List of Abbreviations}\\}
\vspace*{0.5cm}         
\begin{acronym}

\acro{WMN}{Wireless Mesh Networks}
\acro{AP}{Access Point}
\acro{BSS}{Basic Service Set}
\acro{MANET}{Mobile Ad-Hoc Network}
\acro{GSF}{Gracia Sense fils}
\acro{QMP}{Quick Mesh Project}
\acro{NAT}{Network Address Translation}
\acro{BMX6}{BatMan-eXperimental version 6}
\acro{OLSR6}{Optimized Linked State Routing version 6}
\acro{DRP}{Dynamic Routing Protocol}
\acro{IID}{Internal IDentifier}
\acro{WAN}{Wide Area Network}
\acro{PoE}{Power over Ethernet}
\acro{LAN}{Local Area Network}
\acro{RTSP}{Real Time Streaming Protocol}
\acro{NCD}{Network Characterization Daemon}

\end{acronym}

%COMENÇA EL TEXT
\mainmatter
\chapter{Introduction}
TODO
\chapter{State of the Art}

This project consists on studying how are, currently, being build  the open mesh networks in cities and what mechanisms we have to contribute or improve them. There are many different ways to improve this networks, namely, we can use different hardware, different software, build applications which run over them, etc.

First of all, we will analyze how these networks are, and how are they operating to have a better idea of what we want to improve.

\section{Mesh and MANET networks}

\subsection{Definition and properties}

When we talk about mesh networks, we refer to networks where all the participant are also routers. If we had to set a single definition the following can be a good one:
\\[10pt]
``\textit{A Mesh network is one where all nodes (participants) are routers, meaning that all the nodes accept and forward packets from other nodes according to the routing rules.}'' \cite{paupfc}
\\[12pt] 
%Acronimo para añadir
More specifically, we want to talk about \ac{WMN} which may refer also to the users of the network, and can be defined as follows:
\\[10pt]
``\textit{Wireless mesh networks often consist of mesh clients, mesh routers and gateways. The mesh clients are often laptops, cell phones and other wireless devices while the mesh routers forward traffic to and from the gateways which may but need not connect to the Internet.}'' \cite{huynhsimulation}
\\[12pt]

To summarize, we have that mesh networks are basically networks which are not defined by the topology (physical layer) or the kind of links between two nodes (link layer). They are defined by the way the nodes operate among them, there are not master/slave or node/supernode distinctions and so, all the nodes have a similar function. In addition, the clients (end users) do not notice any difference (between mesh or other kind of networks) when they connect to the mesh, it is totally transparent for them. 
\\[12pt]

As mentioned above, there are only two different kind of nodes: mesh routers and mesh gateways. They operate in exactly the same way when they have to route packets within the network, the only difference is that the gateways may be connected to a wider network, namely, the Internet and they can route packets to this other network. So, mesh routers just route packets inside the mesh while mesh gateways can also route packets to the outside. 
\\[12pt]

	\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/wmn11.jpg}}
\captionof{figure}{Wireless Mesh Network Example}% only if needed
\caption*{http://www.intechopen.com/source/html/37888/media/wmn11.jpg}
\label{city}
\end{minipage}
\nocite{WMNs}
\clearpage

Then, we can say that WMN are a subtype of mesh networks. They have all the properties of these networks with the only difference that all the nodes are connected wirelessly. 

\subsection{Operating modes}
\nocite{qmpPresentation}

Mesh networks can operate in two different modes: Infrastructure mode and Ad-Hoc mode.

\begin{itemize}
	\item \textbf{Infrastructure Mode: }In this mode we have a central point named \ac{AP} that creates a \ac{BSS} zone in which all the packets have to go through the AP. This zone is identified by the MAC address of the AP, which is called BSSID in this context. Furthermore, we can say that a master/slave model is followed in infrastructure mode.
	
		\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/InfMode.png}}
\captionof{figure}{Infrastructure Mode BSS}% only if needed
\caption*{\cite{qmpPresentation}}
\label{Infrastructure}
\end{minipage}

\clearpage
	\item \textbf{Ad-Hoc Mode: }In Ad-Hoc mode, all the participants play the same role. Therefore, every single node connects with all the nodes it can, and so the central point idea disappears. To identify which participants are in the same network we just need to find those who have the same BSSID. At this point, all the machines directly connected can exchange information but, a layer 3 routing protocol is required to allow the communication between nodes which are not connected directly. 
	
	\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/AdhocMode.png}}
\captionof{figure}{Ad-Hoc Mode BSS}% only if needed
\caption*{\cite{qmpPresentation}}
\label{Ad-hoc}
\end{minipage}
\end{itemize}

\subsection{MANET Networks}

\ac{MANET} is a subtype of a mesh network. That is to say, when we have a mesh network which uses a wireless system to interconnect the nodes and is built in Ad-hoc mode, we talk about \ac{MANET}. Another way to define it can be: A \ac{MANET} network is a \ac{WMN} which operates in Ad-Hoc mode. 
\\[12pt]

Usually, when we talk about \ac{MANET} we are also referring to networks which have a self-configuring property. This property relies on the fact that the routers within the network are free-to-move anytime and to anywhere. A good definition could be this:
\\[12pt]

``\textit{A Mobile Ad hoc NETwork (MANET) is a kind of wireless ad-hoc network, and is a self-configuring network of mobile routers (and associated hosts) connected by wireless links - the union of which forms an arbitrary topology.}''\cite{Manetdef}
\\[12pt]


\section{Open \ac{MANET} Networks in Barcelona}

Nowadays, in Barcelona (and in some other cities) some MANET networks are being deployed. We will study this case in particular because is the one we are more familiar with. In general terms, all the deployments work in the same manner and so, studying one single case can give us a general a idea of all of them.
\\[12pt]

Normally, all these deployments only differ in some points, these are the more relevant ones:

\begin{itemize}
	\item The funding scheme
	\item The kind of hardware
	\item The firmware used 
\end{itemize}


\subsection{Funding scheme in Barcelona's \ac{MANET} networks}

There are some examples of MANET networks successfully deployed in Barcelona:

\begin{itemize}
	\item Gràcia
	\item Sants
	\item Poble Nou
	\item Sant Joan Despí
\end{itemize}


All these networks have been deployed using the same funding scheme, promoted by the Guifi.net foundation, and is, somehow, based on crowd-funding. Basically, anyone can install a new node and join to the mesh. There is just one restriction: you have to have direct vision with, at least, another node in the network. If you achieve this requirement, you can buy and install the node yourself and you expand the network. So, this is crowd-funding because every person joining the network funds its own equipment, which has the only requirement of being compatible with the firmware used. Since many people has no experience on installing and configuring the nodes, and despite the fact that both the hardware and software are specially designed to allow non-technical people to use it without problems, the foundation provides technical support for those who do not achieve in the installation. 

\subsection{The Kind of hardware in Barcelona's \ac{MANET} networks}

Being that the users are the owners of the network and so, the people who buy the equipment, usually low-cost hardware is used. Low-cost does not mean, low-quality, in fact some of the hardware used have very high features and a very good performance. Normally, the hardware used is from Ubiquity Networks (NanoStation, Rocket, Bullet, etc.), but it is not strictly necessary. Actually, any hardware compatible with the linux distribution openWRT is accepted. 
\\[10pt]

There are more information about some of this devices in Appendix 2.

\subsection{The Firmware used in Barcelona's \ac{MANET} networks}

This is maybe the most important difference between all the deployments around the world. In most of them, there is a common point: all the firmwares are openWRT based, but they have some differences. Particularly, in Barcelona the first deployments used the \ac{GSF} firmware, developed since 2003 for the Gracia Sense Fils Wireless Community\footnote{More information at: http://graciasensefils.net/}. Some year later, the firmware became outdated since the protocol versions were old and the configuration of the nodes was hard. Then, they decided to create a new firmware with bigger scope, they named it \ac{QMP} and is the one being used currently (some nodes have to be migrated to \ac{QMP} yet).
\\[12pt]

\ac{QMP} has been chosen in Barcelona because is a firmware that covers perfectly the needs in the deployments carried out there, and has been developed by themselves. Nowadays, in most of the deployments a new firmware is designed specially for them, and despite the fact that many of them could be used in other deployments, it does not normally happen. It is not an efficient way to work, and because of it a new initiative has just started, it is called ``libre-mesh''\footnote{More information at: http://libre-mesh.org/}. This initiative tries to build a new firmware based on three existent ones: QMP (Spain), AlterMesh (Argentina) and eigenNet (Italy). It can be a good opportunity to merge all the best points of every firmware a create a new version that fits in many different scenarios.

\section{\ac{QMP} firmware basics}

\subsection{Main Features}

\ac{QMP} \footnote{ http://qmp.cat} is an Operating System designed for embedded devices, a firmware. The main features of this firmware are:


\begin{itemize}
	\item OpenWRT based
	\item 802.11a/b/g/n support
	\item IPv6 native
	\item IPv4 tunneled over IPv6
	\item Auto configuration system
	\item Web GUI to monitor and configure
	\item Visualization tools (maps, graphs, etc.)
	\item Automatic dynamic routing  (zero-conf)
	\item BGP (Border Gateway Protocol) support
	\item Open Source 
\end{itemize}

\subsection{Quick Deployments}

\ac{QMP} has been specially designed and developed to achieve quick network deployments. To do so, they have created the auto configuration feature which plays a very important role within the firmware. When we talk about quick deployments, we mean that we have to accomplish these requirements:
 
 \begin{itemize}
	 \item The deployment must be performed as fast as possible.
	 \item It must be able to be done by non-technical people.
	 \item It must be possible in most situations.
\end{itemize}

\subsection{Addressing}

\ac{QMP} uses three different kind of IP addresses:

\begin{itemize}
	\item IPv6 ULA: IPv6 private range to be used internally in the mesh. These IPs are used for the communication among the nodes in the mesh network, and so they are not neither valid nor routable outside.
	\item IPv6 RIPE: IPv6 public IPs range (6to6 tunneling). These are globally valid and routable.
	\item IPv4: IPv4 private range to connect with the final user (4to6 tunneling). They are assigned to the final users attached to a node in the mesh, when 	they transmit any packet that has to travel throughout the mesh it is encapsulated in an IPv6 packet (tunneling).
\end{itemize}


\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/qmpAddr.png}}
\captionof{figure}{QMP Addressing}% only if needed
\caption*{\cite{qmpPresentation}}
\label{AddrQMP}
\end{minipage}

\subsection{Operating modes}

The firmware has two different operating modes, depending on the scenario we should choose one or the other:


\begin{itemize}
	\item Roaming for fast deployments: All the access points in this mode will have the same IP and the same ESSID in order to allow users mobility, namely, they will not lose the connection although they switch from an \ac{AP} to another. Every AP implements a \ac{NAT} and so, two users attached to different \ac{AP}s will not have direct vision between them.

	\item Community: Every node will have a randomly assigned IPs range and will announce this range through the mesh. There is not \ac{NAT}, every user has direct vision with the others (1 hope away from the IPv4 network layer point of view), but mobility is not allowed (no roaming).
\end{itemize}


\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/qmpModes.png}}
\captionof{figure}{QMP Operating Modes}% only if needed
\caption*{\cite{qmpPresentation}}
\label{ModesQMP}
\end{minipage}


\subsection{\ac{DRP}}

The firmware uses different protocols:


\begin{itemize}
	\item  \ac{BMX6} as the main \ac{DRP}.
  \item  \ac{OLSR6} as a backup \ac{DRP}.
  \item  Babel as a backup \ac{DRP} but optional. 
\end{itemize}

Usually, two networks are built in parallel the main one using \ac{BMX6} and the backup on using \ac{OLSR6}. There are two reasons for that:

\begin{enumerate}
	\item To prevent that a node gets isolated (no neighbors) due to a single \ac{BMX6} failure. 
	\item To make performance measurements of both protocols in exactly the same environment. This was very useful at the beginning of the project to decide which protocol was better in every scenario.
\end{enumerate}


All these three protocols use IPv6 ULA to talk to other nodes and are isolated at the link layer (MAC) using VLANs. It allows the protocols to work in parallel (if necessary) without interfering with the other protocols. 


\subsection{\ac{BMX6}}

Since \ac{BMX6} is the main \ac{DRP} we are going to analyze it deeply:
\\[10pt]

``\textit{\ac{BMX6} is a table-driven routing protocol for wireless mesh networks. [...] its goal is to compose a path from source to destination by deciding on each node which will be the next hop. \ac{BMX6} is a distance vector protocol, since the information each node manages is [...] destination node, next hop and cost. }'' \cite{Bmx6}
\\[12pt]

In terms of dissemination - how the nodes exchange the information - we can distinguish between two different states: transient and steady. 


\begin{itemize}
	\item Transient phase: the nodes exchange information related to the environment: \ac{IID}, nodes description, links, etc. Thanks to this information, ever single node builds a dictionary table that translates between \ac{IID} to the global hashes of the full node description.
	\item Steady phase: every node has local information state (\ac{IID}-to-hash dictionary) and global information state as hash-to-description.  So, during this phase there is just a small exchange of packets that informs about link metrics and network changes. Thank to the tables set up in transient phase, those packets do not need to use the 128 bit IPv6 address as the identifier, they can use the 16 bit \ac{IID} which produces a much lower overhead. 
\end{itemize}

To summarize, we can say say that \ac{BMX6} controls the overhead better than other protocols (some experiments demonstrate that, for example: \cite{Bmx6}) there is a big overhead at the very beginning (transient state) and later it becomes very low during the steady state. So the main features of this protocol are:


\begin{itemize}
	\item Pro-active: Uses UDP flooding to periodically send Originator Messages (OGM) and build a routing table.
	\item Destination-sequenced, Distance-vector (DSDV): 		Every node just knows which neighbor is better to reach another, namely, they do not need to know the entire topology, just the best paths.
	\item Does not use IP as node identifier, it uses global identifiers using SHA2 hashing. 
\end{itemize}


In terms of the kind of frames used by \ac{BMX6} we have two different types:  periodic messages, periodically generated on every node and occasional messages, exchanged only when necessary. The most used are the periodical which are the following:
\\[12pt]

\noindent%
\begin{minipage}{\linewidth}
%\begin{center}
\begin{tabular}{| c | p{0.8\linewidth} |}
\hline \textbf{Frame name} & \textbf{Description} \\
\hline HELLO\_ADV & Hello advertisement. Used for letting neighboring nodes detect the link quality in transmit direction (from sending to receiving node).\\
\hline RP\_ADV & Rx probe advertisement. Used for reporting about reception rate of hello messages from neighboring nodes.\\
\hline OGM\_ADV & OGM advertisement. Used for updating periodically route and metric information over the mesh.\\
\hline OGM\_ACK & OGM acknowledgment. Used for acknowledging the previously reception of a full OGM\_ADV frame.\\
\hline
\end{tabular}
\captionof{table}{BMX6 Frames}
\caption*{\cite{paupfc}}
\label{table:bmx6_frames}
%\end{center} 
\end{minipage}
  
\chapter{Contribution}

As we mentioned in previous chapters, we wanted to find ways to contribute to current open mesh networks, by providing ideas, introducing new hardware (or new ways to use the existing one) or building applications that run over the network.
\\[12pt]

We can divide the contribution of this project in three different points:


\begin{enumerate}
	\item Study and documentation of the Mobile Node project
	\item Installation of a node within Poblenou Mesh
	\item Development of an audio and/or video streaming Android application
\end{enumerate}


\section{Mobile Node Project}

\nocite{efrainMedia}
The mobile node is a portable and auto-configurable transmission unit with wireless technology that offers mobility in the urban space. This node is designed to contribute to the digital mesh through existing networks. Furthermore, it provides connectivity with a wide range of different hardware: fixed nodes, other mobile nodes, smartphones, pc, tablets, etc.
\\[12pt]

The basic idea that lies behind the concept of the mobile node, is the socialization and modeling of the networks according to the interests and needs of communities and citizens, completely changing the paradigm. At present, networks are designed and deployed based on corporate and/or government interests, this fact does not allow the home user to control its data flows and, much less, get involved in the process.
\\[12pt]

In other words, what we are doing with the Mobile Node, is making the most of the hardware and firmware we have, combining them and using the resulting device in a different way. So, a mobile node, in our context, is a device that can be used to expand networks already deployed and give coverage to a zone where there was no coverage at this time. Therefore, we are taking advantage of the ``Auto-configuration'' feature of \ac{QMP} to provide Internet Access rapidly.
\\[12pt]

The main advantage of this device, is the speed and freedom that offers. Given this features, the most common usage	will be as a temporary solution to cover a particular zone during a certain period of time. It can be very useful in events, congresses, concerts, parties, etc. Which will  take just a few hours or days. Using this device in cities like Barcelona, where fixed mesh networks are quite extended, will allow the organizers of the events to provide Internet Access to the attendants in a very fast, easy and cheap manner. 
\\[12pt]

Although covering events is, perhaps, the main usage we can give to our mobile node it is not the only one. Since we are talking about open networks, with open firmware we have the freedom to use them as we prefer. Normally, the mobile nodes are supplied using batteries which will last just some hours, but it is not strictly necessary to use them that way. We could join a community or create a new one and model our own networks using mobile nodes, there are no restrictions considering that a mobile node is nothing but the same hardware and the same firmware used in a different way. 
\\[12pt]

Given all these facts, that is the reason why we talk about changing the paradigm and start modeling the networks according to the interests of those who are going to use them.
\\[12pt]

So, the biggest contribution we did in that field, was to write a document talking about the project, its origins, how to build our first mobile node, the hardware we need, how to configure some devices and build a small mesh, the prototypes that are being tested nowadays, etc. Since this is a project which is being carried out by Efraín Foglia with the support of Mobility Lab, we just took all the information and started doing experiments to build the networks and the nodes, but did not do anything new. So we created a document gathering all the information that will allow beginners to start learning and working in that field. This document can be found at appendix 2.    

\section{New node in Poblenou Mesh}

As we already mentioned in previous chapters, nowadays, Barcelona has plenty of open mesh networks working, one of them is the one placed at Poblenou neighborhood. Most of the nodes of the network, are still using the old firmware \ac{GSF} and some members of guifi.net and some volunteers are trying to update all of them to \ac{QMP}. Since our campus is placed in Poblenou and the main building in one of the tallest of the neighborhood we decided to contribute to the mesh by placing a node on the roof of that building. 
\\[12pt]

Being that it was the first time we were working with this kind of firmware and hardware we followed a set of steps before deploying the node.

\subsection{Choice of Hardware}

Given the position and height of the building, and the physical situation of the other nodes, we made a first approximation which said that we should cover an angle between 70 and 100 degrees. Thanks to the previous experience of the \ac{QMP} and guifi.net teams, the decision did not take too much time since they solved many similar situations in the past. Their recommendation was to use a Rocket M5 from Ubiquity Networks together with a 90 degrees sector antenna. 
\\[12pt]

The main features of these hardware are:


\begin{itemize}
	\item Rocket M5: 
	
	\begin{itemize}
		\item Description: Outdoor base station which transmits in the 5GHz band
		\item Protocols: 802.11a, 802.11n
		\item Outside reach: more than 50km (depending on the antenna)
		\item Transmission frequency: 4900-5800MHz
		\item Max. Transmitted power: 27 dBm
	\end{itemize}
	
\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.35 \linewidth]{Images/rocket.jpg}}
\captionof{figure}{Rocket M5}% only if needed
\label{rocket}
\end{minipage}
\\[10pt]

	\item Airmax 5G-17-90:
	
	\begin{itemize}
		\item Description: 90 Degree, 5 Ghz, MIMO, 17 dbi Sector antenna for ROCKET M5
	\end{itemize}
	
	\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/airmaxRocket.jpg}}
\captionof{figure}{Airmax 5G-17-90}% only if needed
\label{airmaxRocket}
\end{minipage}

\end{itemize}

\subsection{Lab Testbed}

In order to test the hardware and firmware before deploying the node, we created a testbed in the lab. We took three different nodes, installed \ac{QMP} and built a small mesh to get familiar with this kind of networks. 
\\[12pt] 

The devices we chose were: Nanostation M5, Alix 2D2 and Rocket M5. We flashed\footnote{More details on how to flash the nodes in appendix 2} them with the most recent version of the firmware and we got an indoor mesh:

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/firstMesh.png}}
\captionof{figure}{First testing mesh}% only if needed
\label{firstMesh}
\end{minipage}
\\[10pt]

Thanks to the firmware, the nodes recognized each other in a few seconds and the network was deployed automatically. The next step was to set at least one of the nodes as a gateway to a wider network, the Internet in this case. We connected the \ac{WAN} interface of the Nanostation to a switch with an output to the Internet and waited for a result. In a few seconds, the Nanostation had announced this gateway throughout the mesh and so, all the nodes added a new entry to their tables showing the path to get this network.

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.9 \linewidth]{Images/gatewayMesh.png}}
\captionof{figure}{First testing mesh with gateway}% only if needed
\label{gatewayMesh}
\end{minipage}
\\[10pt]

Afterwards, we wanted to test if this gateway was actually working or not. To do so, we connected some clients via Wi-Fi to the Alix and tried to access to the Internet from them. 


\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.9 \linewidth]{Images/clientsMesh.png}}
\captionof{figure}{First testing mesh with gateway and clients}% only if needed
\label{clientsMesh}
\end{minipage}
\\[10pt]

It worked as expected, and we could access the Internet without problems, fact that proved that we had built the mesh properly and that both hardware and firmware were doing their job perfectly. 

\subsection{Physical installation of the Rocket M5}

Once we had tested that the hardware was working well and that we could build a mesh without problems, we proceeded to the installation of the device on the roof of the building. To do so, we just needed to point the antenna to the right direction and set the same transmission channel of the other nodes. Here we have some pictures of the result:
\\[10pt]

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/rocket1.jpg}}
\captionof{figure}{Rocket M5 installed on the roof of Roc Boronat Building (1)}% only if needed
\label{rocketinstalled1}
\end{minipage}

\clearpage

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/rocket2.jpg}}
\captionof{figure}{Rocket M5 installed on the roof of Roc Boronat Building (2)}% only if needed
\label{rocketinstalled2}
\end{minipage}
\\[12pt]

To be able to supply the node, and access to it to change the configuration or check any feature, we connected both  the \ac{PoE} and \ac{LAN} interfaces to a switch which allowed us to do both things:
\clearpage

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=0.8 \linewidth]{Images/rocketSwitch.jpg}}
\captionof{figure}{Rocket M5 connected to the Switch}% only if needed
\label{rocketSwitch}
\end{minipage}
\\[12pt]

At the moment, we have direct vision with one other node. At the same time, this node is connected to another one, so we have a mesh of three nodes deployed. 
\clearpage

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=1.0 \linewidth]{Images/meshPoblenou.jpg}}
\captionof{figure}{Poblenou Mesh nodes}% only if needed
\label{meshPoblenou}
\end{minipage}
\\[12pt]

We can also see the graph that displays how are the nodes connected among them:

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=1.0 \linewidth]{Images/meshNodes.jpg}}
\captionof{figure}{Poblenou Mesh nodes distribution}% only if needed
\label{meshNodes}
\end{minipage}
\\[12pt]

The main purpose of these networks is to provide Internet Access, and in this particular network one of the nodes is acting as a gateway to the Internet and we can access to it from any of the nodes in the Mesh. 


\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=1.0 \linewidth]{Images/meshLinks.jpg}}
\captionof{figure}{Poblenou Mesh announced links}% only if needed
\label{meshLinks}
\end{minipage}
\clearpage

\section{Mobile Node Android Application}

This application, is specially designed to work in a scenario together with the mobile node, however, it may work in any \ac{LAN}. The application basically streams the video and audio captured by the smartphone camera throughout the \ac{LAN} and any client within the network can receive it. So, we have two separated entities acting in this scenario: the app which is the server and a computer which is the client. 

\subsection{Server side}

The server side, will run the app in a smartphone and it will be usually done by the final user. The user, will just need to choose the options (frame rate, bit rate, height, etc) or leave the default ones and accept them. At this moment, the app is ready to receive incoming connections from any client. When a connection is received, the server will start the streaming session.

\subsubsection{Generic Use cases}

\noindent%
\begin{minipage}{\linewidth}
%\begin{center}
\begin{tabular}{| c | p{0.7\linewidth} |}
\hline \textbf{Case} & Open the app and choose the options\\
\hline \textbf{Context} & The users wants to choose a particular configuration before starting the stream\\
\hline \textbf{Primary Actors} & User\\
\hline \textbf{Preconditions} & The user has the app installed in the Smartphone and has launched it.\\
\hline \textbf{Post-conditions success} & The user chooses and accepts the settings and the app is ready to start the stream\\
\hline \textbf{Post-conditions failure} & The settings cannot be accepted due to an internal error or a user's mistake. The streaming session cannot start.\\
\hline \textbf{Main stage for Success} & 
\begin{enumerate}
	\item The user launches the app.
	\item All the options (resolution, bitrate, framerate, etc) are chosen or left by default.
	\item The settings are accepted.
	\item The app is ready to start streaming sessions.
\end{enumerate}
\\
\hline \textbf{Extensions} & -\\
\hline
\end{tabular}
\captionof{table}{Server Side Use Case 1}
\label{table:serverUseCases}
%\end{center} 
\end{minipage}

\noindent%
\begin{minipage}{\linewidth}
%\begin{center}
\begin{tabular}{| c | p{0.7\linewidth} |}
\hline \textbf{Case} & Share the URL on Twitter before accepting the settings\\
\hline \textbf{Context} & The users wants to share its URL on twitter\\
\hline \textbf{Primary Actors} & User\\
\hline \textbf{Preconditions} & The User presses the ``Share Url'' button\\
\hline \textbf{Post-conditions success} & The twitter app (if installed) or the browser launch with a tweet ready to be posted.\\
\hline \textbf{Post-conditions failure} & Neither the twitter app nor the browser launch, or they do it wrong.\\
\hline \textbf{Main stage for Success} & 
\begin{enumerate}
	\item The user launches the app.
	\item The user presses ``Share Url'' button.
	\item Twitter app or browser launch.
	\item The user presses the ``send tweet'' button.
	\item The tweet is posted correctly.
\end{enumerate}
\\
\hline \multirow{4}{*}{\textbf{Extensions}} & 3.a Neither twitter app nor browser launch\\
 & 3.a.1 Return to Step 2\\
 & 5.a The tweet is not posted\\
 & 5.a.1 Return to Step 4\\
\hline
\end{tabular}
\captionof{table}{Server Side Use Case 2}
\label{table:serverUseCases2}
%\end{center} 
\end{minipage}

\noindent%
\begin{minipage}{\linewidth}
%\begin{center}
\begin{tabular}{| c | p{0.7\linewidth} |}
\hline \textbf{Case} & Stop a streaming session once started\\
\hline \textbf{Context} & The user wants to close a session\\
\hline \textbf{Primary Actors} & User\\
\hline \textbf{Preconditions} & A streaming session is running\\
\hline \textbf{Post-conditions success} & The streaming session is closed correctly\\
\hline \textbf{Post-conditions failure} & The session keeps alive\\
\hline \textbf{Main stage for Success} & 
\begin{enumerate}
	\item The user launches the app.
	\item The user accepts the options.
	\item An clients connects.
	\item The streaming session begins.
	\item The user presses the "stop" button.
	\item The session closes.
\end{enumerate}
\\
\hline \multirow{3}{*}{\textbf{Extensions}} & 6.a The session does not close\\
 & 6.a.1 Return to Step 5 if it is a button problem\\
 & 6.a.2 Close the app, and return to step 1 if it is a client problem or a generic app problem\\
\hline
\end{tabular}
\captionof{table}{Server Side Use Case 3}
\label{table:serverUseCases3}
%\end{center} 
\end{minipage}
\clearpage

\subsubsection{Layout}

These are the main layouts of the application:
\\[12pt]


\begin{minipage}{0.5\textwidth}
  \centering
  \includegraphics[width=0.6\linewidth]{Images/app1.png}
  \captionof{figure}{App Options Screen}
  \label{fig:app1}
\end{minipage}%
\begin{minipage}{0.5\textwidth}
  \centering
  \includegraphics[width=0.6\linewidth]{Images/app2.png}
  \captionof{figure}{App Main layout screen}
  \label{fig:app2}
\end{minipage}
\\[12pt]

\begin{minipage}{0.5\textwidth}
  \centering
  \includegraphics[width=0.6\linewidth]{Images/app3.png}
  \captionof{figure}{App Main layout screen with camera on}
  \label{fig:app3}
\end{minipage}
\\[12pt]
 
\subsection{Client side}

For this side of the full system, we have used some open source software to receive the stream. It is important to say, that since this part of the system will not be used by the final user (in normal situations), but for the administrator, it is a little bit harder to make it work right. 
\\[12pt]

We may want two different things when we receive the stream:


\begin{enumerate}
	\item Play back the stream.
  \item Record the stream.
\end{enumerate}

\subsubsection{Play Back}


The simplest way to connect to the server and play the stream is using a software compatible with \ac{RTSP} which is the protocol that uses the app to send the data. The most common one, and the one we have used in our tests, is VLC\footnote{http://www.videolan.org/vlc/}. During the tests, we have realized that in some cases the app and the player are not fully compatible and there are some problems during the first seconds of the session causing an unexpected timeout. 
\\[12pt]


Whenever we encounter this problem, we can use an intermediary between the app and vlc. This intermediary is a proxy server that establishes the connection with the RTSP Server in the app and allows multiple clients to connect to it an receive the stream. We have used an open source software called Live555 Proxy Server\footnote{http://www.live555.com/proxyServer/}. Using this intermediary, vlc is able to receive the stream much better (in some cases) than connecting directly to the app, and there are no errors. So the logic to make it work would be:


\begin{enumerate}
	\item Have an app with the server running
	\item Open the proxy server and introduce the app's URL
	\item Open VLC and introduce the new URL generated by the proxy server
	\item Start watching the stream
\end{enumerate}

\noindent%
\begin{minipage}{\linewidth}
\vspace{10 mm}
\makebox[\linewidth]{%
  \includegraphics[width=1.0 \linewidth]{Images/appProxy.png}}
\captionof{figure}{App with proxy and vlc diagram}% only if needed
\label{appProxy}
\end{minipage}

\subsubsection{Record}

In order to record the stream, we have been using a very lightweight open source software called openRTSP\footnote{http://www.live555.com/openRTSP/}. This software allows to connect directly with the app and save into a file all the data received. It is very useful in case we want to have a local copy of the stream to process it later in any way. It runs in a terminal an we just need to type a simple command indicating the record time, the height and width of the video, the bit rate and frame rate and the url of the server. An example of command would be this one: 
\\[10pt]

openRTSP -d 40 -4 -f 15 -w 640 -h 480 -b 400000 ``rtsp://192.168.1.3:8086'' \textgreater video.avi

\subsection{Internal Work flow and challenges}

Now that we know how do the application work from the outside, we will take a look at how does it work internally and we will explain some of the challenges we have had to achieve in order to make everything function well.
\clearpage

\subsubsection{Internal Work Flow}

The logic that the application follows is this one:


\begin{enumerate}
	\item First of all, an activity that allows to choose the preferences is launched.
	\item The user chooses the preferences and presses ``Accept'' button.
	\item Internally, the app sends a message announcing its \ac{RTSP} URL and some information about the video settings.
	\item A new activity is launched, and a connection with localhost is carried out in order to configure the camera with the preferences of the user.
	\item Then the server is ready to receive connections.
	\item When a connection is received, the Server creates a unique session ID for this client and exchanges some control data with the client.
	\item Then, the Android Media Recorder and other classes are used to record and send the data captured by the camera.
	\item When either the client or the server (pressing stop button) decide to close the session, all the information is removed in the server and the app becomes ready to receive other connections.
\end{enumerate}

\subsubsection{Challenges}

The main challenges that we had to face when developing the application were:

\begin{itemize}
	\item How to stop a session from server side. This was a difficult part because, \ac{RTSP} does not implement a way to close a session from server side by default. In addition, there was a complex multithreading scheme working behind and closing a session was not trivial. In the end, we found a way to stop all the threads and subthreads that allowed us to achieve our goal.
		\item How does the client side know the \ac{RTSP} URL and the video features of the server? This was maybe the biggest challenge of the project, it is very easy to know the URL when you have the smartphone in front of you, but the idea of this app is that the server and the client are run by different people. So, we had to, somehow, let the client know the IP address of the server. We tried different solutions, like sharing the URL on twitter or implementing an XMPP based chat between server and client. Since any of these solutions were not exactly what we were looking for, we decided to implement a multicast client-server application to share the information. IP Multicast is a technique for one-to-many or many-to-many real time communication over IP networks, the main idea is that all the participants join to a multicast group, and all the messages are sent just once setting the destination IP as the group IP. With this, and thanks to some protocols like  Internet Group Management Protocol(IGMP), whenever a message is sent to this IP, all the members of the group will receive it. It was perfect to solve our problem, because we did not need to know the IP address of the others to exchange information. 
\end{itemize}
\nocite{diot2000deployment}

\subsection{Other information about the app}

Some parts of the code, have been derived from some open-source projects such as: spydroid\footnote{https://code.google.com/p/spydroid-ipcamera/}, android-eye\footnote{https://github.com/Teaonly/android-eye}
\\[12pt]

The source code of the application can be found on github on the following site: https://github.com/ferry91/MobileNode-App
\\[12pt]

The application is under a GPL license, which means that any individual, organization or company has the freedoms to use, study, share(copy) and modify the software. And, since GPL is a copyleft license, all the derived works have to be distributed under the same license terms.
\\[12pt]

The application will be presented at Sonar in the Market Lab within the Sonar+D section\footnote{http://www.sonar.es/es/2013/pg/market-place\_221} in Friday 15th of June together with the Mobile Node and the Mobility Lab platform.

\chapter{Conclusions}

During this thesis we have analyzed and studied some different topics, which can work independently or together. This is maybe the most important feature of this field, mesh networks can be open or not, can run application over them or not, can use a any compatible hardware and in any imaginable way. 
\\[12pt]

In terms of open mesh networks, we have studied some real cases which are currently deployed and working well. So, we could say that the model they have followed is, mostly, successful. As in any starting model, we always have some thing that can be improved, in particular in the cases we have studied we could highlight some of them:


\begin{itemize}
	\item The networks have been deployed in some neighborhoods with a relatively small amount of nodes, and most people do not even know them. To become known and the process of involving more people can be one of the things that need to be improved. The profile of the people involved is usually technical, but to make this networks grow and become important in people everyday life, something has to be changed. The dissemination of this projects is usually small and only people who is working on that fields or is really interested on them get to know them. We should start looking at open networks as a benefit for the society since they can be modeled and deployed following our needs and not the needs of corporations or organizations. It is true that it is still difficult to find ways to get people really involved with this kind of projects, only a small percentage of the population participates actively on them because they normally think that these are things that will benefit others but not themselves. 
	\item In terms of hardware there is no problem because there is a wide variety of devices which can be used and they have similar performance and compatibility with the others.
	\item The firmware is different at this point, the main problem  (as we mentioned before) is that every team develops its own firmware with the features they think are better. Therefore, for these people who is not used to this projects it can be a problem, being that they do not really know the differences among the different firmwares. It would be important to, somehow, standardize all the firmwares in one. Despite the fact that every deployment can have different needs, a single firmware may be able to be configured in different ways to reach that needs without having to develop a new one. 
\end{itemize}

As we have seen during this thesis, making a network grow has a lot of different connotations. It is not strictly necessary to make it grow in terms of size or number of nodes, you can just improve the performance or add a new functionality by choosing the most optimal firmware or building an application. 
\\[12pt]

The mobile node is a perfect example of this, a workstation which adds new possibilities to the existing networks with a combination of hardware and firmware. The mobile node application increases these possibilities even more, although it can be used without the mobile node itself. 
\\[12pt]

To conclude, we can say that all this initiatives try to improve they way we access the Internet nowadays. Not necessarily in terms of performance or speed, but in terms of covering the needs of the final users and offering them the opportunity to decide what is better for them in every single situation. 
 

\chapter{Future Work}

This field is very open, and we will always be able to continue working and developing new features. Just to mention some of the possibilities that are being considered nowadays:


\begin{itemize}
	\item Developing a \ac{NCD} to publish some information about the nodes such as, WiFi links, Routing Neighbors, throughput of the links, number of routes, number of associated clients to a node, etc. This daemon may run inside every node and would publish the data periodically to a server in HTTP-JSON format. This can be a useful tool because we can derive lots of applications from it, for example, a mobile/web application to show the network topology in real-time, which would allow to find the best places to install new nodes. 
	\item Try to develop a firmware which covers most of the needs of the users and becomes, somehow, a standard. This would avoid the current problem of having this variety of different firmware.
	\item Think about new ways to combine hardware, firmware and apps to offer new possibilities to this networks.
	\item Find ways to get more people involved on that initiatives, it is a difficult task but also a very important one.
\end{itemize}

As we can see, there are no limitations on that field. Any new combination, any new application related to this field can always improve the whole ecosystem.  



\bibliography{bibliography}
\cleardoublepage

\chapter{Appendixes}
\appendix

\section{Appendix 1: Pilot Charter}
\includepdf[pages={-}]{Appendix/projectcharterMN.pdf}

\section{Appendix 2: Documentation}
\includepdf[pages={-}]{Appendix/Documentation.pdf}

\section{Appendix 3: QMP Presentation}
\includepdf[pages={1-19}]{Appendix/QMPDemo.pdf}



\backmatter
\printindex





\end{document}


%NUMERACIÓ DE LA PÀGINA EXTERIOR EXCEPTE EN LA PRIMERA PÀGINA DE CADA CAPÍTOL
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyfoot{}
\fancyfoot[RO]{\thepage}
\fancyfoot[LE]{\thepage}


%MUTIPLES ÍNDEX
%En el preàmbul
\usepackage{multind}
\makeindex{authors}
%Introducció d'entrades la forma
\index{authors}{Einstein}
%Situació de l'Índex
\printindex{authors}{Author index}
%Cal eliminar les comandes \usepakage{makeidx} \makeindex \printindex
%cal exacutar des de la línia de comandes makeindex authors